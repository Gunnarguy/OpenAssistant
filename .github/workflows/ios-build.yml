name: iOS Build and Test

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  SCHEME: OpenAssistant
  PROJECT: OpenAssistant.xcodeproj

jobs:
  build-and-test:
    name: Build and Test iOS App
    runs-on: macos-15
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode 26.2
        run: |
          sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer
          echo "Using: $(xcodebuild -version | head -1)"

      - name: Get Simulator
        id: sim
        run: |
          # Prefer iPhone 17 Pro Max, fallback through available devices
          for DEVICE in "iPhone 17 Pro Max" "iPhone 17 Pro" "iPhone 16 Pro Max" "iPhone 16 Pro"; do
            if xcrun simctl list devices available | grep -q "$DEVICE"; then
              echo "device=$DEVICE" >> "$GITHUB_OUTPUT"
              echo "Using simulator: $DEVICE"
              exit 0
            fi
          done
          # Ultimate fallback
          DEVICE=$(xcrun simctl list devices available | grep -oE 'iPhone [^(]+' | head -1 | xargs)
          echo "device=$DEVICE" >> "$GITHUB_OUTPUT"

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods
        run: |
          if [ -f Podfile ]; then
            gem install cocoapods
            pod install --repo-update
          else
            echo "No Podfile found, skipping pod install"
          fi

      - name: Build for iOS Simulator
        run: |
          if [ -f OpenAssistant.xcworkspace/contents.xcworkspacedata ]; then
            xcodebuild clean build \
              -workspace OpenAssistant.xcworkspace \
              -scheme ${{ env.SCHEME }} \
              -destination 'platform=iOS Simulator,name=${{ steps.sim.outputs.device }}' \
              -configuration Debug \
              CODE_SIGNING_ALLOWED=NO
          else
            xcodebuild clean build \
              -project ${{ env.PROJECT }} \
              -scheme ${{ env.SCHEME }} \
              -destination 'platform=iOS Simulator,name=${{ steps.sim.outputs.device }}' \
              -configuration Debug \
              CODE_SIGNING_ALLOWED=NO
          fi
