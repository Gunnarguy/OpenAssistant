name: iOS Build and Test

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  SCHEME: OpenAssistant
  PROJECT: OpenAssistant.xcodeproj

jobs:
  build-and-test:
    name: Build and Test iOS App
    runs-on: macos-15
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode_16*.app 2>/dev/null | sort -V | tail -1 || echo "/Applications/Xcode.app")
          sudo xcode-select -s "$XCODE_PATH/Contents/Developer"
          echo "Using: $(xcodebuild -version | head -1)"

      - name: Get Simulator
        id: sim
        run: |
          DEVICE=$(xcrun simctl list devices available | grep -oE 'iPhone [0-9]+ Pro' | head -1 | xargs)
          [ -z "$DEVICE" ] && DEVICE=$(xcrun simctl list devices available | grep -oE 'iPhone [^(]+' | head -1 | xargs)
          echo "device=$DEVICE" >> "$GITHUB_OUTPUT"
          echo "Using simulator: $DEVICE"

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods
        run: |
          if [ -f Podfile ]; then
            gem install cocoapods
            pod install --repo-update
          else
            echo "No Podfile found, skipping pod install"
          fi

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-derived-data-${{ hashFiles('**/*.xcodeproj') }}
          restore-keys: |
            ${{ runner.os }}-derived-data-

      - name: Build for iOS Simulator
        run: |
          # Use workspace if Pods exist, otherwise project
          if [ -f OpenAssistant.xcworkspace/contents.xcworkspacedata ]; then
            xcodebuild clean build \
              -workspace OpenAssistant.xcworkspace \
              -scheme ${{ env.SCHEME }} \
              -destination 'platform=iOS Simulator,name=${{ steps.sim.outputs.device }}' \
              -configuration Debug \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGN_IDENTITY="" \
              PROVISIONING_PROFILE=""
          else
            xcodebuild clean build \
              -project ${{ env.PROJECT }} \
              -scheme ${{ env.SCHEME }} \
              -destination 'platform=iOS Simulator,name=${{ steps.sim.outputs.device }}' \
              -configuration Debug \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGN_IDENTITY="" \
              PROVISIONING_PROFILE=""
          fi
